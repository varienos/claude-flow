{"version":3,"sources":["../../../../src/mcp/registry/mcp-registry-client-2025.ts"],"sourcesContent":["/**\n * MCP 2025-11 Registry Client\n *\n * Implements server registration and health reporting\n * per MCP 2025-11 specification\n */\n\nimport type { ILogger } from '../../interfaces/logger.js';\nimport type { MCPVersion, MCPCapability } from '../protocol/version-negotiation.js';\n\n/**\n * MCP Registry entry (2025-11 format)\n */\nexport interface MCPRegistryEntry {\n  server_id: string;\n  version: MCPVersion;\n  endpoint: string;\n  tools: string[];\n  auth: 'bearer' | 'mutual_tls' | 'none';\n  capabilities: MCPCapability[];\n  metadata: {\n    name: string;\n    description: string;\n    author: string;\n    homepage?: string;\n    documentation?: string;\n    repository?: string;\n  };\n  health: {\n    status: 'healthy' | 'degraded' | 'unhealthy';\n    last_check: string; // ISO 8601\n    latency_ms: number;\n  };\n}\n\n/**\n * Registry search query\n */\nexport interface RegistrySearchQuery {\n  category?: string;\n  tags?: string[];\n  capabilities?: MCPCapability[];\n  limit?: number;\n}\n\n/**\n * Registry configuration\n */\nexport interface RegistryConfig {\n  enabled: boolean;\n  registryUrl?: string;\n  apiKey?: string;\n  serverId: string;\n  serverEndpoint: string;\n  authMethod: 'bearer' | 'mutual_tls' | 'none';\n  metadata: MCPRegistryEntry['metadata'];\n  healthCheckInterval?: number; // milliseconds\n}\n\n/**\n * MCP 2025-11 Registry Client\n */\nexport class MCPRegistryClient {\n  private registryUrl: string;\n  private healthCheckInterval?: NodeJS.Timeout;\n\n  constructor(\n    private config: RegistryConfig,\n    private logger: ILogger,\n    private getTools: () => Promise<string[]>,\n    private getCapabilities: () => MCPCapability[],\n    private getHealth: () => Promise<{ status: 'healthy' | 'degraded' | 'unhealthy'; latency_ms: number }>\n  ) {\n    this.registryUrl = config.registryUrl || 'https://registry.mcp.anthropic.com/api/v1';\n  }\n\n  /**\n   * Register server with MCP Registry\n   */\n  async register(): Promise<void> {\n    if (!this.config.enabled) {\n      this.logger.info('Registry registration disabled');\n      return;\n    }\n\n    try {\n      const entry = await this.buildRegistryEntry();\n\n      this.logger.info('Registering server with MCP Registry', {\n        server_id: entry.server_id,\n        endpoint: entry.endpoint,\n        capabilities: entry.capabilities,\n      });\n\n      const response = await fetch(`${this.registryUrl}/servers`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...(this.config.apiKey && {\n            'Authorization': `Bearer ${this.config.apiKey}`,\n          }),\n        },\n        body: JSON.stringify(entry),\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(`Registration failed: ${response.status} - ${error}`);\n      }\n\n      const result = await response.json();\n      this.logger.info('Server registered successfully', {\n        server_id: result.server_id,\n      });\n\n      // Start periodic health reporting\n      this.startHealthReporting();\n    } catch (error) {\n      this.logger.error('Failed to register with MCP Registry', {\n        error: error instanceof Error ? error.message : String(error),\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Update server metadata in registry\n   */\n  async updateMetadata(updates: Partial<MCPRegistryEntry>): Promise<void> {\n    if (!this.config.enabled) {\n      return;\n    }\n\n    try {\n      this.logger.info('Updating server metadata in registry', {\n        server_id: this.config.serverId,\n      });\n\n      const response = await fetch(\n        `${this.registryUrl}/servers/${this.config.serverId}`,\n        {\n          method: 'PATCH',\n          headers: {\n            'Content-Type': 'application/json',\n            ...(this.config.apiKey && {\n              'Authorization': `Bearer ${this.config.apiKey}`,\n            }),\n          },\n          body: JSON.stringify(updates),\n        }\n      );\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(`Update failed: ${response.status} - ${error}`);\n      }\n\n      this.logger.info('Server metadata updated successfully');\n    } catch (error) {\n      this.logger.error('Failed to update metadata', {\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n  }\n\n  /**\n   * Report health status to registry\n   */\n  async reportHealth(): Promise<void> {\n    if (!this.config.enabled) {\n      return;\n    }\n\n    try {\n      const health = await this.getHealth();\n\n      const response = await fetch(\n        `${this.registryUrl}/servers/${this.config.serverId}/health`,\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            ...(this.config.apiKey && {\n              'Authorization': `Bearer ${this.config.apiKey}`,\n            }),\n          },\n          body: JSON.stringify({\n            status: health.status,\n            last_check: new Date().toISOString(),\n            latency_ms: health.latency_ms,\n          }),\n        }\n      );\n\n      if (!response.ok) {\n        this.logger.warn('Health report failed', {\n          status: response.status,\n        });\n      }\n    } catch (error) {\n      this.logger.error('Failed to report health', {\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n  }\n\n  /**\n   * Search for servers in registry\n   */\n  async searchServers(query: RegistrySearchQuery): Promise<MCPRegistryEntry[]> {\n    try {\n      const params = new URLSearchParams();\n\n      if (query.category) {\n        params.set('category', query.category);\n      }\n      if (query.tags) {\n        params.set('tags', query.tags.join(','));\n      }\n      if (query.capabilities) {\n        params.set('capabilities', query.capabilities.join(','));\n      }\n      if (query.limit) {\n        params.set('limit', query.limit.toString());\n      }\n\n      const response = await fetch(`${this.registryUrl}/servers?${params}`);\n\n      if (!response.ok) {\n        throw new Error(`Search failed: ${response.status}`);\n      }\n\n      const results = await response.json();\n      return results.servers || [];\n    } catch (error) {\n      this.logger.error('Failed to search servers', {\n        error: error instanceof Error ? error.message : String(error),\n      });\n      return [];\n    }\n  }\n\n  /**\n   * Unregister from registry\n   */\n  async unregister(): Promise<void> {\n    if (!this.config.enabled) {\n      return;\n    }\n\n    // Stop health reporting\n    this.stopHealthReporting();\n\n    try {\n      this.logger.info('Unregistering from MCP Registry', {\n        server_id: this.config.serverId,\n      });\n\n      const response = await fetch(\n        `${this.registryUrl}/servers/${this.config.serverId}`,\n        {\n          method: 'DELETE',\n          headers: {\n            ...(this.config.apiKey && {\n              'Authorization': `Bearer ${this.config.apiKey}`,\n            }),\n          },\n        }\n      );\n\n      if (!response.ok) {\n        this.logger.warn('Unregistration failed', {\n          status: response.status,\n        });\n      } else {\n        this.logger.info('Server unregistered successfully');\n      }\n    } catch (error) {\n      this.logger.error('Failed to unregister', {\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n  }\n\n  /**\n   * Build registry entry from current server state\n   */\n  private async buildRegistryEntry(): Promise<MCPRegistryEntry> {\n    const tools = await this.getTools();\n    const capabilities = this.getCapabilities();\n    const health = await this.getHealth();\n\n    return {\n      server_id: this.config.serverId,\n      version: '2025-11',\n      endpoint: this.config.serverEndpoint,\n      tools,\n      auth: this.config.authMethod,\n      capabilities,\n      metadata: this.config.metadata,\n      health: {\n        status: health.status,\n        last_check: new Date().toISOString(),\n        latency_ms: health.latency_ms,\n      },\n    };\n  }\n\n  /**\n   * Start periodic health reporting\n   */\n  private startHealthReporting(): void {\n    const interval = this.config.healthCheckInterval || 60000; // Default: 60 seconds\n\n    this.healthCheckInterval = setInterval(async () => {\n      await this.reportHealth();\n    }, interval);\n\n    this.logger.info('Health reporting started', {\n      interval_ms: interval,\n    });\n  }\n\n  /**\n   * Stop health reporting\n   */\n  private stopHealthReporting(): void {\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n      this.healthCheckInterval = undefined;\n      this.logger.info('Health reporting stopped');\n    }\n  }\n}\n"],"names":["MCPRegistryClient","registryUrl","healthCheckInterval","config","logger","getTools","getCapabilities","getHealth","register","enabled","info","entry","buildRegistryEntry","server_id","endpoint","capabilities","response","fetch","method","headers","apiKey","body","JSON","stringify","ok","error","text","Error","status","result","json","startHealthReporting","message","String","updateMetadata","updates","serverId","reportHealth","health","last_check","Date","toISOString","latency_ms","warn","searchServers","query","params","URLSearchParams","category","set","tags","join","limit","toString","results","servers","unregister","stopHealthReporting","tools","version","serverEndpoint","auth","authMethod","metadata","interval","setInterval","interval_ms","clearInterval","undefined"],"mappings":"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"}