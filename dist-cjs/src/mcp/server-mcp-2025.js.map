{"version":3,"sources":["../../../src/mcp/server-mcp-2025.ts"],"sourcesContent":["/**\n * MCP 2025-11 Enhanced Server\n *\n * Integrates all MCP 2025-11 features with full backward compatibility:\n * - Version negotiation\n * - Async job support\n * - Registry integration\n * - JSON Schema 1.1 validation\n * - Dual-mode operation (2025-11 + legacy)\n */\n\nimport type { ILogger } from '../interfaces/logger.js';\nimport type { IEventBus } from '../interfaces/event-bus.js';\nimport { VersionNegotiator, BackwardCompatibilityAdapter, type MCPHandshake, type MCPVersion, type MCPCapability } from './protocol/version-negotiation.js';\nimport { MCPAsyncJobManager, type MCPToolRequest, type MCPJobHandle, type MCPJobResult } from './async/job-manager-mcp25.js';\nimport { MCPRegistryClient, type RegistryConfig } from './registry/mcp-registry-client-2025.js';\nimport { SchemaValidator, upgradeToolSchema } from './validation/schema-validator-2025.js';\nimport { ProgressiveToolRegistry } from './tool-registry-progressive.js';\n\n/**\n * MCP 2025-11 server configuration\n */\nexport interface MCP2025ServerConfig {\n  serverId: string;\n  transport: 'stdio' | 'http' | 'ws';\n\n  // Version & capabilities\n  enableMCP2025: boolean; // Feature flag for gradual rollout\n  supportLegacyClients: boolean; // Backward compatibility\n\n  // Async jobs\n  async: {\n    enabled: boolean;\n    maxJobs?: number;\n    jobTTL?: number;\n    persistence?: 'memory' | 'redis' | 'sqlite';\n  };\n\n  // Registry\n  registry: RegistryConfig;\n\n  // Schema validation\n  validation: {\n    enabled: boolean;\n    strictMode?: boolean;\n  };\n\n  // Tool registry\n  toolsDirectory?: string;\n\n  // Existing config\n  orchestratorContext?: any;\n}\n\n/**\n * MCP 2025-11 Enhanced Server\n */\nexport class MCP2025Server {\n  private versionNegotiator: VersionNegotiator;\n  private compatibilityAdapter: BackwardCompatibilityAdapter;\n  private jobManager?: MCPAsyncJobManager;\n  private registryClient?: MCPRegistryClient;\n  private schemaValidator: SchemaValidator;\n  private toolRegistry: ProgressiveToolRegistry;\n\n  // Session state\n  private sessions: Map<string, {\n    clientId: string;\n    version: MCPVersion;\n    capabilities: MCPCapability[];\n    isLegacy: boolean;\n  }> = new Map();\n\n  constructor(\n    private config: MCP2025ServerConfig,\n    private eventBus: IEventBus,\n    private logger: ILogger\n  ) {\n    // Initialize version negotiation\n    this.versionNegotiator = new VersionNegotiator(logger);\n    this.compatibilityAdapter = new BackwardCompatibilityAdapter(logger);\n\n    // Initialize schema validator\n    this.schemaValidator = new SchemaValidator(logger);\n\n    // Initialize tool registry (progressive)\n    this.toolRegistry = new ProgressiveToolRegistry({\n      enableInProcess: true,\n      enableMetrics: true,\n      enableCaching: true,\n      orchestratorContext: config.orchestratorContext,\n      toolsDirectory: config.toolsDirectory,\n    });\n\n    this.logger.info('MCP 2025-11 server created', {\n      serverId: config.serverId,\n      mcp2025Enabled: config.enableMCP2025,\n      legacySupport: config.supportLegacyClients,\n    });\n  }\n\n  /**\n   * Initialize server\n   */\n  async initialize(): Promise<void> {\n    this.logger.info('Initializing MCP 2025-11 server');\n\n    // Initialize tool registry\n    await this.toolRegistry.initialize();\n\n    // Initialize async job manager if enabled\n    if (this.config.async.enabled) {\n      this.jobManager = new MCPAsyncJobManager(\n        null, // Use memory persistence for now\n        this.logger,\n        {\n          maxJobs: this.config.async.maxJobs,\n          jobTTL: this.config.async.jobTTL,\n        }\n      );\n\n      this.logger.info('Async job manager initialized');\n    }\n\n    // Initialize registry client if enabled\n    if (this.config.registry.enabled) {\n      this.registryClient = new MCPRegistryClient(\n        this.config.registry,\n        this.logger,\n        () => this.toolRegistry.getToolNames(),\n        () => this.versionNegotiator.getServerCapabilities(),\n        async () => this.getHealthStatus()\n      );\n\n      // Register with MCP Registry\n      try {\n        await this.registryClient.register();\n      } catch (error) {\n        this.logger.error('Failed to register with MCP Registry', { error });\n        // Don't fail initialization if registry is unavailable\n      }\n    }\n\n    this.logger.info('MCP 2025-11 server initialized successfully');\n  }\n\n  /**\n   * Handle client connection/handshake\n   */\n  async handleHandshake(clientHandshake: any, sessionId: string): Promise<MCPHandshake> {\n    // Check if legacy client\n    const isLegacy = this.compatibilityAdapter.isLegacyRequest(clientHandshake);\n\n    let handshake: MCPHandshake;\n    if (isLegacy && this.config.supportLegacyClients) {\n      this.logger.info('Legacy client detected, enabling compatibility mode', { sessionId });\n      handshake = this.compatibilityAdapter.convertToModern(clientHandshake);\n    } else {\n      handshake = clientHandshake;\n    }\n\n    // Negotiate version and capabilities\n    const negotiation = await this.versionNegotiator.negotiate(handshake);\n\n    if (!negotiation.success) {\n      throw new Error(`Version negotiation failed: ${negotiation.error}`);\n    }\n\n    // Store session info\n    this.sessions.set(sessionId, {\n      clientId: handshake.client_id || 'unknown',\n      version: negotiation.agreed_version,\n      capabilities: negotiation.agreed_capabilities,\n      isLegacy,\n    });\n\n    // Create server handshake response\n    const serverHandshake = this.versionNegotiator.createServerHandshake(\n      this.config.serverId,\n      this.config.transport,\n      {\n        name: 'Claude Flow',\n        version: '2.7.32',\n        description: 'Enterprise AI orchestration with MCP 2025-11 support',\n      }\n    );\n\n    // Apply agreed version and capabilities\n    serverHandshake.mcp_version = negotiation.agreed_version;\n    serverHandshake.capabilities = negotiation.agreed_capabilities;\n\n    this.logger.info('Handshake completed', {\n      sessionId,\n      version: serverHandshake.mcp_version,\n      capabilities: serverHandshake.capabilities,\n      isLegacy,\n    });\n\n    return serverHandshake;\n  }\n\n  /**\n   * Handle tool call request (with async support)\n   */\n  async handleToolCall(\n    request: MCPToolRequest | any,\n    sessionId: string\n  ): Promise<MCPJobHandle | MCPJobResult | any> {\n    const session = this.sessions.get(sessionId);\n\n    // Handle legacy request format\n    if (session?.isLegacy) {\n      return this.handleLegacyToolCall(request, sessionId);\n    }\n\n    // MCP 2025-11 format\n    const mcpRequest = request as MCPToolRequest;\n\n    // Validate request\n    if (!mcpRequest.tool_id) {\n      throw new Error('Missing tool_id in request');\n    }\n\n    // Get tool\n    const tool = await this.toolRegistry.getTool(mcpRequest.tool_id);\n    if (!tool) {\n      throw new Error(`Tool not found: ${mcpRequest.tool_id}`);\n    }\n\n    // Validate input if validation enabled\n    if (this.config.validation.enabled) {\n      const validation = this.schemaValidator.validateInput(\n        upgradeToolSchema(tool.inputSchema),\n        mcpRequest.arguments\n      );\n\n      if (!validation.valid) {\n        throw new Error(\n          `Invalid input: ${validation.errors?.map(e => e.message).join(', ')}`\n        );\n      }\n    }\n\n    // Check if async mode requested\n    const hasAsyncCapability = session?.capabilities.includes('async');\n    const isAsyncRequest = mcpRequest.mode === 'async' && hasAsyncCapability;\n\n    if (isAsyncRequest && this.jobManager) {\n      // Submit as async job\n      this.logger.info('Submitting async job', {\n        tool_id: mcpRequest.tool_id,\n        request_id: mcpRequest.request_id,\n      });\n\n      return await this.jobManager.submitJob(\n        mcpRequest,\n        async (args, onProgress) => {\n          // Execute tool with progress tracking\n          return await tool.handler(args, {\n            orchestrator: this.config.orchestratorContext,\n            sessionId,\n          });\n        }\n      );\n    } else {\n      // Execute synchronously\n      this.logger.info('Executing tool synchronously', {\n        tool_id: mcpRequest.tool_id,\n        request_id: mcpRequest.request_id,\n      });\n\n      const startTime = Date.now();\n      const result = await tool.handler(mcpRequest.arguments, {\n        orchestrator: this.config.orchestratorContext,\n        sessionId,\n      });\n\n      // Validate output if validation enabled\n      if (this.config.validation.enabled && tool.metadata?.outputSchema) {\n        const validation = this.schemaValidator.validateOutput(\n          tool.metadata.outputSchema,\n          result\n        );\n\n        if (!validation.valid) {\n          this.logger.warn('Output validation failed', {\n            tool_id: mcpRequest.tool_id,\n            errors: validation.errors,\n          });\n        }\n      }\n\n      // Return in MCP 2025-11 format\n      return {\n        request_id: mcpRequest.request_id,\n        status: 'success',\n        result,\n        metadata: {\n          duration_ms: Date.now() - startTime,\n        },\n      } as MCPJobResult;\n    }\n  }\n\n  /**\n   * Handle legacy tool call\n   */\n  private async handleLegacyToolCall(request: any, sessionId: string): Promise<any> {\n    this.logger.info('Handling legacy tool call', {\n      toolName: request.name || request.method,\n      sessionId,\n    });\n\n    // Convert to modern format internally\n    const toolId = request.name || request.method;\n    const args = request.arguments || request.params || {};\n\n    const tool = await this.toolRegistry.getTool(toolId);\n    if (!tool) {\n      throw new Error(`Tool not found: ${toolId}`);\n    }\n\n    const result = await tool.handler(args, {\n      orchestrator: this.config.orchestratorContext,\n      sessionId,\n    });\n\n    // Return in legacy format\n    return this.compatibilityAdapter.convertToLegacy(\n      { result, status: 'success' },\n      true\n    );\n  }\n\n  /**\n   * Poll async job\n   */\n  async pollJob(job_id: string): Promise<MCPJobHandle> {\n    if (!this.jobManager) {\n      throw new Error('Async jobs not enabled');\n    }\n\n    return await this.jobManager.pollJob(job_id);\n  }\n\n  /**\n   * Resume async job (get results)\n   */\n  async resumeJob(job_id: string): Promise<MCPJobResult> {\n    if (!this.jobManager) {\n      throw new Error('Async jobs not enabled');\n    }\n\n    return await this.jobManager.resumeJob(job_id);\n  }\n\n  /**\n   * Cancel async job\n   */\n  async cancelJob(job_id: string): Promise<boolean> {\n    if (!this.jobManager) {\n      throw new Error('Async jobs not enabled');\n    }\n\n    return await this.jobManager.cancelJob(job_id);\n  }\n\n  /**\n   * List async jobs\n   */\n  async listJobs(filter?: { status?: string; limit?: number }) {\n    if (!this.jobManager) {\n      throw new Error('Async jobs not enabled');\n    }\n\n    return await this.jobManager.listJobs(filter);\n  }\n\n  /**\n   * Get health status\n   */\n  private async getHealthStatus(): Promise<{\n    status: 'healthy' | 'degraded' | 'unhealthy';\n    latency_ms: number;\n  }> {\n    const startTime = Date.now();\n\n    // Perform health checks\n    const latency = Date.now() - startTime;\n\n    // Determine status based on metrics\n    let status: 'healthy' | 'degraded' | 'unhealthy' = 'healthy';\n\n    if (latency > 100) {\n      status = 'degraded';\n    }\n    if (latency > 500) {\n      status = 'unhealthy';\n    }\n\n    return { status, latency_ms: latency };\n  }\n\n  /**\n   * Get metrics\n   */\n  getMetrics() {\n    return {\n      sessions: {\n        total: this.sessions.size,\n        byVersion: this.getSessionsByVersion(),\n        legacy: Array.from(this.sessions.values()).filter(s => s.isLegacy).length,\n      },\n      jobs: this.jobManager?.getMetrics(),\n      tools: this.toolRegistry.getMetrics(),\n      validation: this.schemaValidator.getCacheStats(),\n    };\n  }\n\n  private getSessionsByVersion() {\n    const counts: Record<string, number> = {};\n    for (const session of this.sessions.values()) {\n      counts[session.version] = (counts[session.version] || 0) + 1;\n    }\n    return counts;\n  }\n\n  /**\n   * Cleanup resources\n   */\n  async cleanup(): Promise<void> {\n    this.logger.info('Cleaning up MCP 2025-11 server');\n\n    // Unregister from registry\n    if (this.registryClient) {\n      await this.registryClient.unregister();\n    }\n\n    // Clear caches\n    this.schemaValidator.clearCache();\n    await this.toolRegistry.cleanup();\n\n    this.logger.info('Cleanup complete');\n  }\n}\n"],"names":["VersionNegotiator","BackwardCompatibilityAdapter","MCPAsyncJobManager","MCPRegistryClient","SchemaValidator","upgradeToolSchema","ProgressiveToolRegistry","MCP2025Server","versionNegotiator","compatibilityAdapter","jobManager","registryClient","schemaValidator","toolRegistry","sessions","Map","config","eventBus","logger","enableInProcess","enableMetrics","enableCaching","orchestratorContext","toolsDirectory","info","serverId","mcp2025Enabled","enableMCP2025","legacySupport","supportLegacyClients","initialize","async","enabled","maxJobs","jobTTL","registry","getToolNames","getServerCapabilities","getHealthStatus","register","error","handleHandshake","clientHandshake","sessionId","isLegacy","isLegacyRequest","handshake","convertToModern","negotiation","negotiate","success","Error","set","clientId","client_id","version","agreed_version","capabilities","agreed_capabilities","serverHandshake","createServerHandshake","transport","name","description","mcp_version","handleToolCall","request","session","get","handleLegacyToolCall","mcpRequest","tool_id","tool","getTool","validation","validateInput","inputSchema","arguments","valid","errors","map","e","message","join","hasAsyncCapability","includes","isAsyncRequest","mode","request_id","submitJob","args","onProgress","handler","orchestrator","startTime","Date","now","result","metadata","outputSchema","validateOutput","warn","status","duration_ms","toolName","method","toolId","params","convertToLegacy","pollJob","job_id","resumeJob","cancelJob","listJobs","filter","latency","latency_ms","getMetrics","total","size","byVersion","getSessionsByVersion","legacy","Array","from","values","s","length","jobs","tools","getCacheStats","counts","cleanup","unregister","clearCache"],"mappings":"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"}