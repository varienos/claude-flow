{"version":3,"sources":["../../../../src/mcp/protocol/version-negotiation.ts"],"sourcesContent":["/**\n * MCP 2025-11 Version Negotiation Protocol\n *\n * Implements version negotiation and capability exchange\n * per MCP 2025-11 specification\n */\n\nimport type { ILogger } from '../../interfaces/logger.js';\n\n/**\n * MCP version in YYYY-MM format\n */\nexport type MCPVersion = '2025-11' | '2024-11' | '2024-10';\n\n/**\n * MCP capability flags\n */\nexport type MCPCapability =\n  | 'async'       // Job handles, poll/resume\n  | 'registry'    // Self-registration\n  | 'code_exec'   // External code execution\n  | 'stream'      // Streaming output\n  | 'sandbox'     // Isolated execution\n  | 'schema_ref'; // Shared schema references\n\n/**\n * MCP handshake request/response\n */\nexport interface MCPHandshake {\n  mcp_version: MCPVersion;\n  client_id?: string;\n  server_id?: string;\n  transport: 'stdio' | 'http' | 'ws';\n  capabilities: MCPCapability[];\n  metadata?: {\n    name?: string;\n    version?: string;\n    description?: string;\n  };\n}\n\n/**\n * Version negotiation result\n */\nexport interface NegotiationResult {\n  success: boolean;\n  agreed_version: MCPVersion;\n  agreed_capabilities: MCPCapability[];\n  error?: string;\n}\n\n/**\n * Version negotiation errors\n */\nexport class VersionNegotiationError extends Error {\n  constructor(\n    message: string,\n    public code: 'VERSION_MISMATCH' | 'UNSUPPORTED_CAPABILITY' | 'INVALID_HANDSHAKE'\n  ) {\n    super(message);\n    this.name = 'VersionNegotiationError';\n  }\n}\n\n/**\n * MCP Version Negotiator\n *\n * Handles version compatibility checking and capability negotiation\n */\nexport class VersionNegotiator {\n  // Supported versions in order of preference\n  private supportedVersions: MCPVersion[] = ['2025-11', '2024-11'];\n\n  // Current server version\n  private serverVersion: MCPVersion = '2025-11';\n\n  // Server capabilities\n  private serverCapabilities: MCPCapability[] = [\n    'async',\n    'registry',\n    'code_exec',\n    'stream',\n  ];\n\n  constructor(private logger: ILogger) {}\n\n  /**\n   * Negotiate version with client\n   */\n  async negotiate(clientHandshake: MCPHandshake): Promise<NegotiationResult> {\n    this.logger.info('Starting version negotiation', {\n      clientVersion: clientHandshake.mcp_version,\n      serverVersion: this.serverVersion,\n      clientCapabilities: clientHandshake.capabilities,\n    });\n\n    // Validate handshake structure\n    if (!this.isValidHandshake(clientHandshake)) {\n      return {\n        success: false,\n        agreed_version: this.serverVersion,\n        agreed_capabilities: [],\n        error: 'Invalid handshake structure',\n      };\n    }\n\n    // Check version compatibility\n    const versionResult = this.checkVersionCompatibility(clientHandshake.mcp_version);\n    if (!versionResult.compatible) {\n      return {\n        success: false,\n        agreed_version: this.serverVersion,\n        agreed_capabilities: [],\n        error: versionResult.error,\n      };\n    }\n\n    // Negotiate capabilities\n    const agreedCapabilities = this.negotiateCapabilities(\n      clientHandshake.capabilities\n    );\n\n    this.logger.info('Version negotiation successful', {\n      agreedVersion: versionResult.version,\n      agreedCapabilities,\n    });\n\n    return {\n      success: true,\n      agreed_version: versionResult.version,\n      agreed_capabilities: agreedCapabilities,\n    };\n  }\n\n  /**\n   * Check if handshake is valid\n   */\n  private isValidHandshake(handshake: MCPHandshake): boolean {\n    return !!(\n      handshake.mcp_version &&\n      handshake.transport &&\n      Array.isArray(handshake.capabilities)\n    );\n  }\n\n  /**\n   * Check version compatibility\n   */\n  private checkVersionCompatibility(clientVersion: MCPVersion): {\n    compatible: boolean;\n    version: MCPVersion;\n    error?: string;\n  } {\n    // Exact match - best case\n    if (clientVersion === this.serverVersion) {\n      return { compatible: true, version: clientVersion };\n    }\n\n    // Check if client version is supported\n    if (this.supportedVersions.includes(clientVersion)) {\n      this.logger.warn('Client using older version, but compatible', {\n        clientVersion,\n        serverVersion: this.serverVersion,\n      });\n      return { compatible: true, version: clientVersion };\n    }\n\n    // Check version gap\n    const clientDate = this.parseVersion(clientVersion);\n    const serverDate = this.parseVersion(this.serverVersion);\n    const monthsDiff = this.getMonthsDifference(clientDate, serverDate);\n\n    // Reject if more than 1 cycle (1 month) difference\n    if (Math.abs(monthsDiff) > 1) {\n      return {\n        compatible: false,\n        version: this.serverVersion,\n        error: `Version mismatch: client ${clientVersion}, server ${this.serverVersion}. Difference exceeds 1 cycle.`,\n      };\n    }\n\n    // Accept with warning for small differences\n    this.logger.warn('Version close enough, accepting', {\n      clientVersion,\n      serverVersion: this.serverVersion,\n      monthsDiff,\n    });\n    return { compatible: true, version: this.serverVersion };\n  }\n\n  /**\n   * Negotiate capabilities between client and server\n   */\n  private negotiateCapabilities(\n    clientCapabilities: MCPCapability[]\n  ): MCPCapability[] {\n    // Return intersection of client and server capabilities\n    return clientCapabilities.filter(cap =>\n      this.serverCapabilities.includes(cap)\n    );\n  }\n\n  /**\n   * Parse version string to date\n   */\n  private parseVersion(version: MCPVersion): Date {\n    const [year, month] = version.split('-').map(Number);\n    return new Date(year, month - 1, 1);\n  }\n\n  /**\n   * Calculate months difference between dates\n   */\n  private getMonthsDifference(date1: Date, date2: Date): number {\n    const months = (date2.getFullYear() - date1.getFullYear()) * 12;\n    return months + date2.getMonth() - date1.getMonth();\n  }\n\n  /**\n   * Create server handshake response\n   */\n  createServerHandshake(\n    serverId: string,\n    transport: 'stdio' | 'http' | 'ws',\n    metadata?: MCPHandshake['metadata']\n  ): MCPHandshake {\n    return {\n      mcp_version: this.serverVersion,\n      server_id: serverId,\n      transport,\n      capabilities: this.serverCapabilities,\n      metadata,\n    };\n  }\n\n  /**\n   * Get current server version\n   */\n  getServerVersion(): MCPVersion {\n    return this.serverVersion;\n  }\n\n  /**\n   * Get server capabilities\n   */\n  getServerCapabilities(): MCPCapability[] {\n    return [...this.serverCapabilities];\n  }\n\n  /**\n   * Check if capability is supported\n   */\n  hasCapability(capability: MCPCapability): boolean {\n    return this.serverCapabilities.includes(capability);\n  }\n\n  /**\n   * Add capability (dynamic capability registration)\n   */\n  addCapability(capability: MCPCapability): void {\n    if (!this.serverCapabilities.includes(capability)) {\n      this.serverCapabilities.push(capability);\n      this.logger.info('Capability added', { capability });\n    }\n  }\n\n  /**\n   * Remove capability\n   */\n  removeCapability(capability: MCPCapability): void {\n    const index = this.serverCapabilities.indexOf(capability);\n    if (index > -1) {\n      this.serverCapabilities.splice(index, 1);\n      this.logger.info('Capability removed', { capability });\n    }\n  }\n}\n\n/**\n * Backward compatibility helper\n * Converts legacy requests to MCP 2025-11 format\n */\nexport class BackwardCompatibilityAdapter {\n  constructor(private logger: ILogger) {}\n\n  /**\n   * Detect if request is legacy format\n   */\n  isLegacyRequest(request: any): boolean {\n    // Legacy requests don't have mcp_version field\n    return !request.mcp_version || request.version;\n  }\n\n  /**\n   * Convert legacy request to MCP 2025-11 format\n   */\n  convertToModern(legacyRequest: any): MCPHandshake {\n    this.logger.info('Converting legacy request to MCP 2025-11 format');\n\n    return {\n      mcp_version: '2025-11',\n      client_id: legacyRequest.clientId || 'legacy-client',\n      transport: legacyRequest.transport || 'stdio',\n      capabilities: legacyRequest.capabilities || [],\n      metadata: {\n        name: legacyRequest.name || 'Legacy Client',\n        version: legacyRequest.version || '1.0.0',\n      },\n    };\n  }\n\n  /**\n   * Convert modern response to legacy format if needed\n   */\n  convertToLegacy(modernResponse: any, requestedLegacy: boolean): any {\n    if (!requestedLegacy) {\n      return modernResponse;\n    }\n\n    this.logger.info('Converting response to legacy format');\n\n    return {\n      version: modernResponse.mcp_version,\n      serverId: modernResponse.server_id,\n      capabilities: modernResponse.capabilities,\n      ...modernResponse,\n    };\n  }\n}\n"],"names":["VersionNegotiationError","Error","message","code","name","VersionNegotiator","supportedVersions","serverVersion","serverCapabilities","logger","negotiate","clientHandshake","info","clientVersion","mcp_version","clientCapabilities","capabilities","isValidHandshake","success","agreed_version","agreed_capabilities","error","versionResult","checkVersionCompatibility","compatible","agreedCapabilities","negotiateCapabilities","agreedVersion","version","handshake","transport","Array","isArray","includes","warn","clientDate","parseVersion","serverDate","monthsDiff","getMonthsDifference","Math","abs","filter","cap","year","month","split","map","Number","Date","date1","date2","months","getFullYear","getMonth","createServerHandshake","serverId","metadata","server_id","getServerVersion","getServerCapabilities","hasCapability","capability","addCapability","push","removeCapability","index","indexOf","splice","BackwardCompatibilityAdapter","isLegacyRequest","request","convertToModern","legacyRequest","client_id","clientId","convertToLegacy","modernResponse","requestedLegacy"],"mappings":"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"}