{"version":3,"sources":["../../../../../src/mcp/tools/system/search.ts"],"sourcesContent":["/**\n * Tool Search Capability (tools/search)\n *\n * Implements progressive disclosure pattern with tiered detail levels:\n * - names-only: Just tool names (minimal tokens)\n * - basic: Name + description + category\n * - full: Complete schemas with examples\n *\n * This is the key to achieving 98.7% token reduction.\n */\n\nimport type { MCPTool, ClaudeFlowToolContext } from '../../types.js';\nimport type { ILogger } from '../../../interfaces/logger.js';\nimport type { DynamicToolLoader, ToolMetadata } from '../loader.js';\n\ninterface SearchToolsInput {\n  query?: string;\n  category?: string;\n  tags?: string[];\n  detailLevel?: 'names-only' | 'basic' | 'full';\n  limit?: number;\n}\n\ninterface ToolSearchResult {\n  name: string;\n  description?: string;\n  category?: string;\n  tags?: string[];\n  inputSchema?: any;\n  examples?: any[];\n}\n\ninterface SearchToolsResult {\n  success: boolean;\n  tools: ToolSearchResult[];\n  totalMatches: number;\n  detailLevel: string;\n  tokenSavings?: {\n    estimatedFullSize: number;\n    actualSize: number;\n    reductionPercent: number;\n  };\n}\n\n/**\n * Create tool search capability\n *\n * @param loader - Dynamic tool loader instance\n * @param logger - Logger instance\n * @returns MCPTool definition\n */\nexport function createSearchToolsTool(\n  loader: DynamicToolLoader,\n  logger: ILogger\n): MCPTool {\n  return {\n    name: 'tools/search',\n    description: 'Search for tools with configurable detail levels. Use names-only for quick discovery (saves 98%+ tokens), basic for descriptions, full for complete schemas. This is the primary tool discovery mechanism.',\n\n    inputSchema: {\n      type: 'object',\n      properties: {\n        query: {\n          type: 'string',\n          description: 'Search query (searches tool names and descriptions)',\n        },\n        category: {\n          type: 'string',\n          description: 'Filter by category',\n          enum: [\n            'agents',\n            'tasks',\n            'memory',\n            'system',\n            'config',\n            'workflow',\n            'terminal',\n            'query',\n            'swarm',\n            'data',\n            'jobs',\n          ],\n        },\n        tags: {\n          type: 'array',\n          items: { type: 'string' },\n          description: 'Filter by tags (all tags must match)',\n        },\n        detailLevel: {\n          type: 'string',\n          enum: ['names-only', 'basic', 'full'],\n          description: 'Level of detail to return. names-only: just names (fastest, minimal tokens). basic: name + description + category (recommended for discovery). full: complete schemas with examples (use only when needed)',\n          default: 'basic',\n        },\n        limit: {\n          type: 'number',\n          description: 'Maximum number of results (default: 20)',\n          minimum: 1,\n          maximum: 100,\n          default: 20,\n        },\n      },\n      required: [],\n    },\n\n    metadata: {\n      category: 'system',\n      tags: ['discovery', 'search', 'progressive-disclosure', 'tools'],\n      examples: [\n        {\n          description: 'Quick search for agent-related tools (minimal tokens)',\n          input: {\n            query: 'agent',\n            detailLevel: 'names-only',\n            limit: 10,\n          },\n          expectedOutput: {\n            tools: [\n              { name: 'agents/spawn' },\n              { name: 'agents/list' },\n              { name: 'agents/terminate' },\n            ],\n            totalMatches: 5,\n            detailLevel: 'names-only',\n          },\n        },\n        {\n          description: 'Get basic info about system tools',\n          input: {\n            category: 'system',\n            detailLevel: 'basic',\n          },\n          expectedOutput: {\n            tools: [\n              {\n                name: 'system/status',\n                description: 'Get system health status',\n                category: 'system',\n              },\n            ],\n            totalMatches: 3,\n            detailLevel: 'basic',\n          },\n        },\n        {\n          description: 'Get full schema for specific tool',\n          input: {\n            query: 'agents/spawn',\n            detailLevel: 'full',\n            limit: 1,\n          },\n          expectedOutput: {\n            tools: [\n              {\n                name: 'agents/spawn',\n                description: 'Spawn a new agent',\n                category: 'agents',\n                inputSchema: { type: 'object', properties: {} },\n                examples: [],\n              },\n            ],\n            totalMatches: 1,\n            detailLevel: 'full',\n          },\n        },\n      ],\n      detailLevel: 'standard',\n    },\n\n    handler: async (\n      input: any,\n      context?: ClaudeFlowToolContext\n    ): Promise<SearchToolsResult> => {\n      const validatedInput = input as SearchToolsInput;\n      const detailLevel = validatedInput.detailLevel || 'basic';\n      const limit = validatedInput.limit || 20;\n\n      logger.info('tools/search invoked', {\n        query: validatedInput.query,\n        category: validatedInput.category,\n        detailLevel,\n        limit,\n      });\n\n      try {\n        // Search tool metadata (lightweight operation)\n        const metadata = loader.searchTools({\n          category: validatedInput.category,\n          tags: validatedInput.tags,\n          namePattern: validatedInput.query,\n        });\n\n        logger.debug('Tool search results', {\n          totalMatches: metadata.length,\n          detailLevel,\n        });\n\n        // Process results based on detail level\n        const results: ToolSearchResult[] = [];\n        const limitedMetadata = metadata.slice(0, limit);\n\n        for (const meta of limitedMetadata) {\n          if (detailLevel === 'names-only') {\n            // Minimal: Just name (saves most tokens)\n            results.push({ name: meta.name });\n          } else if (detailLevel === 'basic') {\n            // Basic: Name + description + category + tags\n            results.push({\n              name: meta.name,\n              description: meta.description,\n              category: meta.category,\n              tags: meta.tags,\n            });\n          } else if (detailLevel === 'full') {\n            // Full: Load complete tool definition including schema\n            const tool = await loader.loadTool(meta.name, logger);\n            if (tool) {\n              results.push({\n                name: tool.name,\n                description: tool.description,\n                category: meta.category,\n                tags: meta.tags,\n                inputSchema: tool.inputSchema,\n                examples: tool.metadata?.examples || [],\n              });\n            }\n          }\n        }\n\n        // Calculate token savings for demonstration\n        const actualSize = JSON.stringify(results).length;\n        const estimatedFullSize = limitedMetadata.length * 2000; // Estimate 2KB per full tool\n        const reductionPercent = detailLevel === 'full'\n          ? 0\n          : ((estimatedFullSize - actualSize) / estimatedFullSize) * 100;\n\n        logger.info('tools/search completed successfully', {\n          resultsCount: results.length,\n          totalMatches: metadata.length,\n          detailLevel,\n          actualSizeBytes: actualSize,\n          reductionPercent: reductionPercent.toFixed(2),\n        });\n\n        return {\n          success: true,\n          tools: results,\n          totalMatches: metadata.length,\n          detailLevel,\n          tokenSavings:\n            detailLevel !== 'full'\n              ? {\n                  estimatedFullSize,\n                  actualSize,\n                  reductionPercent: Math.round(reductionPercent * 100) / 100,\n                }\n              : undefined,\n        };\n      } catch (error) {\n        logger.error('tools/search failed', {\n          error,\n          input: validatedInput,\n        });\n        throw error;\n      }\n    },\n  };\n}\n\nexport const toolMetadata = {\n  name: 'tools/search',\n  description: 'Search and discover tools with progressive disclosure',\n  category: 'system',\n  detailLevel: 'standard' as const,\n  tags: ['discovery', 'search', 'tools'],\n};\n"],"names":["createSearchToolsTool","loader","logger","name","description","inputSchema","type","properties","query","category","enum","tags","items","detailLevel","default","limit","minimum","maximum","required","metadata","examples","input","expectedOutput","tools","totalMatches","handler","context","validatedInput","info","searchTools","namePattern","debug","length","results","limitedMetadata","slice","meta","push","tool","loadTool","actualSize","JSON","stringify","estimatedFullSize","reductionPercent","resultsCount","actualSizeBytes","toFixed","success","tokenSavings","Math","round","undefined","error","toolMetadata"],"mappings":"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"}