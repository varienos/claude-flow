{"version":3,"sources":["../../../src/mcp/server-factory.ts"],"sourcesContent":["/**\n * MCP Server Factory\n *\n * Creates appropriate MCP server instance based on configuration.\n * Provides seamless transition from legacy MCP to MCP 2025-11 with feature flags.\n */\n\nimport type { IEventBus } from '../interfaces/event-bus.js';\nimport type { ILogger } from '../interfaces/logger.js';\nimport type { MCPConfig } from '../utils/types.js';\nimport { MCPServer, type IMCPServer } from './server.js';\nimport { MCP2025Server, type MCP2025ServerConfig } from './server-mcp-2025.js';\nimport { ProgressiveToolRegistry } from './tool-registry-progressive.js';\n\n/**\n * MCP server feature flags for gradual rollout\n */\nexport interface MCPFeatureFlags {\n  // Enable MCP 2025-11 features\n  enableMCP2025?: boolean;\n\n  // Individual feature flags\n  enableVersionNegotiation?: boolean;\n  enableAsyncJobs?: boolean;\n  enableRegistryIntegration?: boolean;\n  enableSchemaValidation?: boolean;\n\n  // Backward compatibility\n  supportLegacyClients?: boolean;\n\n  // Progressive disclosure (already implemented in Phase 1)\n  enableProgressiveDisclosure?: boolean;\n}\n\n/**\n * Extended MCP configuration with 2025-11 support\n */\nexport interface ExtendedMCPConfig extends MCPConfig {\n  // Feature flags\n  features?: MCPFeatureFlags;\n\n  // MCP 2025-11 specific config\n  mcp2025?: {\n    serverId?: string;\n\n    // Async job configuration\n    async?: {\n      enabled?: boolean;\n      maxJobs?: number;\n      jobTTL?: number;\n      persistence?: 'memory' | 'redis' | 'sqlite';\n    };\n\n    // Registry configuration\n    registry?: {\n      enabled?: boolean;\n      url?: string;\n      apiKey?: string;\n      updateInterval?: number;\n      retryAttempts?: number;\n    };\n\n    // Validation configuration\n    validation?: {\n      enabled?: boolean;\n      strictMode?: boolean;\n    };\n\n    // Tool discovery\n    toolsDirectory?: string;\n  };\n}\n\n/**\n * MCP Server Factory\n *\n * Creates appropriate server instance based on configuration:\n * - MCP2025Server if MCP 2025-11 features enabled\n * - Legacy MCPServer for backward compatibility\n */\nexport class MCPServerFactory {\n  /**\n   * Create MCP server instance based on configuration\n   */\n  static async createServer(\n    config: ExtendedMCPConfig,\n    eventBus: IEventBus,\n    logger: ILogger,\n    orchestrator?: any,\n    swarmCoordinator?: any,\n    agentManager?: any,\n    resourceManager?: any,\n    messagebus?: any,\n    monitor?: any\n  ): Promise<IMCPServer | MCP2025Server> {\n    const features = config.features || {};\n\n    // Determine if MCP 2025-11 should be enabled\n    const useMCP2025 = features.enableMCP2025 === true;\n\n    if (useMCP2025) {\n      logger.info('Creating MCP 2025-11 server with enhanced features');\n      return await this.createMCP2025Server(\n        config,\n        eventBus,\n        logger,\n        orchestrator\n      );\n    } else {\n      logger.info('Creating legacy MCP server (backward compatibility mode)');\n      return this.createLegacyServer(\n        config,\n        eventBus,\n        logger,\n        orchestrator,\n        swarmCoordinator,\n        agentManager,\n        resourceManager,\n        messagebus,\n        monitor\n      );\n    }\n  }\n\n  /**\n   * Create MCP 2025-11 server with enhanced features\n   */\n  private static async createMCP2025Server(\n    config: ExtendedMCPConfig,\n    eventBus: IEventBus,\n    logger: ILogger,\n    orchestrator?: any\n  ): Promise<MCP2025Server> {\n    const features = config.features || {};\n    const mcp2025Config = config.mcp2025 || {};\n\n    // Build MCP 2025-11 server configuration\n    const serverConfig: MCP2025ServerConfig = {\n      serverId: mcp2025Config.serverId || `claude-flow-${Date.now()}`,\n      transport: config.transport || 'stdio',\n\n      // Feature flags\n      enableMCP2025: true,\n      supportLegacyClients: features.supportLegacyClients !== false, // Default true\n\n      // Async jobs\n      async: {\n        enabled: features.enableAsyncJobs !== false, // Default true\n        maxJobs: mcp2025Config.async?.maxJobs || 100,\n        jobTTL: mcp2025Config.async?.jobTTL || 3600000, // 1 hour\n        persistence: mcp2025Config.async?.persistence || 'memory',\n      },\n\n      // Registry integration\n      registry: {\n        enabled: features.enableRegistryIntegration === true,\n        url: mcp2025Config.registry?.url || 'https://registry.mcp.run',\n        apiKey: mcp2025Config.registry?.apiKey,\n        updateInterval: mcp2025Config.registry?.updateInterval || 60000,\n        retryAttempts: mcp2025Config.registry?.retryAttempts || 3,\n      },\n\n      // Schema validation\n      validation: {\n        enabled: features.enableSchemaValidation !== false, // Default true\n        strictMode: mcp2025Config.validation?.strictMode || false,\n      },\n\n      // Tool registry (progressive disclosure)\n      toolsDirectory: mcp2025Config.toolsDirectory,\n      orchestratorContext: orchestrator,\n    };\n\n    // Create and initialize server\n    const server = new MCP2025Server(serverConfig, eventBus, logger);\n    await server.initialize();\n\n    logger.info('MCP 2025-11 server created successfully', {\n      serverId: serverConfig.serverId,\n      features: {\n        versionNegotiation: true,\n        asyncJobs: serverConfig.async.enabled,\n        registry: serverConfig.registry.enabled,\n        validation: serverConfig.validation.enabled,\n        progressiveDisclosure: true,\n      },\n    });\n\n    return server;\n  }\n\n  /**\n   * Create legacy MCP server for backward compatibility\n   */\n  private static createLegacyServer(\n    config: ExtendedMCPConfig,\n    eventBus: IEventBus,\n    logger: ILogger,\n    orchestrator?: any,\n    swarmCoordinator?: any,\n    agentManager?: any,\n    resourceManager?: any,\n    messagebus?: any,\n    monitor?: any\n  ): MCPServer {\n    // Remove extended properties for legacy server\n    const legacyConfig: MCPConfig = {\n      transport: config.transport,\n      host: config.host,\n      port: config.port,\n      tlsEnabled: config.tlsEnabled,\n      enableMetrics: config.enableMetrics,\n      auth: config.auth,\n      loadBalancer: config.loadBalancer,\n      sessionTimeout: config.sessionTimeout,\n      maxSessions: config.maxSessions,\n    };\n\n    const server = new MCPServer(\n      legacyConfig,\n      eventBus,\n      logger,\n      orchestrator,\n      swarmCoordinator,\n      agentManager,\n      resourceManager,\n      messagebus,\n      monitor\n    );\n\n    logger.info('Legacy MCP server created successfully', {\n      transport: config.transport,\n      mode: 'backward-compatibility',\n    });\n\n    return server;\n  }\n\n  /**\n   * Detect optimal server configuration based on environment\n   */\n  static detectOptimalConfig(currentConfig: MCPConfig): ExtendedMCPConfig {\n    const extended: ExtendedMCPConfig = {\n      ...currentConfig,\n      features: {\n        // Enable MCP 2025-11 by default in development, opt-in for production\n        enableMCP2025: process.env.NODE_ENV !== 'production',\n\n        // Individual features (can be overridden)\n        enableVersionNegotiation: true,\n        enableAsyncJobs: true,\n        enableRegistryIntegration: false, // Opt-in\n        enableSchemaValidation: true,\n        supportLegacyClients: true, // Always support legacy\n        enableProgressiveDisclosure: true, // Phase 1 feature\n      },\n      mcp2025: {\n        async: {\n          enabled: true,\n          maxJobs: 100,\n          jobTTL: 3600000,\n          persistence: 'memory',\n        },\n        registry: {\n          enabled: false,\n          url: process.env.MCP_REGISTRY_URL || 'https://registry.mcp.run',\n          apiKey: process.env.MCP_REGISTRY_API_KEY,\n        },\n        validation: {\n          enabled: true,\n          strictMode: false,\n        },\n      },\n    };\n\n    return extended;\n  }\n\n  /**\n   * Validate server configuration\n   */\n  static validateConfig(config: ExtendedMCPConfig): {\n    valid: boolean;\n    errors: string[];\n    warnings: string[];\n  } {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    // Basic validation\n    if (!config.transport) {\n      errors.push('Transport type is required');\n    }\n\n    // MCP 2025-11 specific validation\n    if (config.features?.enableMCP2025) {\n      if (config.features.enableRegistryIntegration && !config.mcp2025?.registry?.apiKey) {\n        warnings.push('Registry integration enabled but no API key provided');\n      }\n\n      if (config.mcp2025?.async?.persistence === 'redis') {\n        warnings.push('Redis persistence not yet implemented, falling back to memory');\n      }\n\n      if (config.mcp2025?.async?.persistence === 'sqlite') {\n        warnings.push('SQLite persistence not yet implemented, falling back to memory');\n      }\n    }\n\n    // Transport validation\n    if (config.transport === 'http') {\n      if (!config.host) {\n        warnings.push('HTTP transport enabled but no host specified, using default');\n      }\n      if (!config.port) {\n        warnings.push('HTTP transport enabled but no port specified, using default');\n      }\n    }\n\n    return {\n      valid: errors.length === 0,\n      errors,\n      warnings,\n    };\n  }\n}\n\n/**\n * Convenience function for creating MCP server\n */\nexport async function createMCPServer(\n  config: MCPConfig | ExtendedMCPConfig,\n  eventBus: IEventBus,\n  logger: ILogger,\n  options?: {\n    orchestrator?: any;\n    swarmCoordinator?: any;\n    agentManager?: any;\n    resourceManager?: any;\n    messagebus?: any;\n    monitor?: any;\n    autoDetectFeatures?: boolean;\n  }\n): Promise<IMCPServer | MCP2025Server> {\n  // Auto-detect optimal configuration if requested\n  const extendedConfig = options?.autoDetectFeatures\n    ? MCPServerFactory.detectOptimalConfig(config)\n    : (config as ExtendedMCPConfig);\n\n  // Validate configuration\n  const validation = MCPServerFactory.validateConfig(extendedConfig);\n\n  if (!validation.valid) {\n    throw new Error(`Invalid MCP configuration: ${validation.errors.join(', ')}`);\n  }\n\n  // Log warnings\n  for (const warning of validation.warnings) {\n    logger.warn('MCP configuration warning', { warning });\n  }\n\n  // Create server\n  return await MCPServerFactory.createServer(\n    extendedConfig,\n    eventBus,\n    logger,\n    options?.orchestrator,\n    options?.swarmCoordinator,\n    options?.agentManager,\n    options?.resourceManager,\n    options?.messagebus,\n    options?.monitor\n  );\n}\n\n/**\n * Check if MCP 2025-11 features are available\n */\nexport function isMCP2025Available(): boolean {\n  try {\n    // Check if required dependencies are available\n    require.resolve('uuid');\n    require.resolve('ajv');\n    require.resolve('ajv-formats');\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get MCP server capabilities based on configuration\n */\nexport function getServerCapabilities(config: ExtendedMCPConfig): string[] {\n  const capabilities: string[] = [];\n\n  if (config.features?.enableMCP2025) {\n    capabilities.push('mcp-2025-11');\n\n    if (config.features.enableVersionNegotiation) {\n      capabilities.push('version-negotiation');\n    }\n\n    if (config.features.enableAsyncJobs) {\n      capabilities.push('async-jobs');\n    }\n\n    if (config.features.enableRegistryIntegration) {\n      capabilities.push('registry');\n    }\n\n    if (config.features.enableSchemaValidation) {\n      capabilities.push('schema-validation');\n    }\n\n    if (config.features.enableProgressiveDisclosure) {\n      capabilities.push('progressive-disclosure');\n    }\n  }\n\n  if (config.features?.supportLegacyClients !== false) {\n    capabilities.push('backward-compatible');\n  }\n\n  return capabilities;\n}\n"],"names":["MCPServer","MCP2025Server","MCPServerFactory","createServer","config","eventBus","logger","orchestrator","swarmCoordinator","agentManager","resourceManager","messagebus","monitor","features","useMCP2025","enableMCP2025","info","createMCP2025Server","createLegacyServer","mcp2025Config","mcp2025","serverConfig","serverId","Date","now","transport","supportLegacyClients","async","enabled","enableAsyncJobs","maxJobs","jobTTL","persistence","registry","enableRegistryIntegration","url","apiKey","updateInterval","retryAttempts","validation","enableSchemaValidation","strictMode","toolsDirectory","orchestratorContext","server","initialize","versionNegotiation","asyncJobs","progressiveDisclosure","legacyConfig","host","port","tlsEnabled","enableMetrics","auth","loadBalancer","sessionTimeout","maxSessions","mode","detectOptimalConfig","currentConfig","extended","process","env","NODE_ENV","enableVersionNegotiation","enableProgressiveDisclosure","MCP_REGISTRY_URL","MCP_REGISTRY_API_KEY","validateConfig","errors","warnings","push","valid","length","createMCPServer","options","extendedConfig","autoDetectFeatures","Error","join","warning","warn","isMCP2025Available","require","resolve","getServerCapabilities","capabilities"],"mappings":"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"}