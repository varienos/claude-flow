{"version":3,"sources":["../../../src/reasoningbank/reasoningbank-adapter.js"],"sourcesContent":["/**\n * ReasoningBank Adapter for Claude-Flow (Node.js Backend)\n *\n * Uses agentic-flow@1.5.13 Node.js backend with SQLite for persistent storage\n * Provides semantic search via embeddings and MMR ranking\n *\n * Backend: SQLite with better-sqlite3\n * Features: Persistent storage, semantic search, memory consolidation\n */\n\nimport * as ReasoningBank from 'agentic-flow/reasoningbank';\nimport { v4 as uuidv4 } from 'uuid';\n\n// Backend instance (singleton)\nlet backendInitialized = false;\nlet initPromise = null;\n\n// Query result cache (LRU)\nconst queryCache = new Map();\nconst CACHE_SIZE = 100;\nconst CACHE_TTL = 60000; // 60 seconds\n\n/**\n * Initialize ReasoningBank Node.js backend\n * @returns {Promise<boolean>}\n */\nasync function ensureInitialized() {\n  if (backendInitialized) {\n    return true;\n  }\n\n  if (initPromise) {\n    return initPromise;\n  }\n\n  initPromise = (async () => {\n    try {\n      // Initialize Node.js backend with SQLite database\n      await ReasoningBank.initialize();\n      backendInitialized = true;\n      console.log('[ReasoningBank] Node.js backend initialized successfully');\n      return true;\n    } catch (error) {\n      // Check if this is the better-sqlite3 missing error (npx issue)\n      const isSqliteError = error.message?.includes('BetterSqlite3 is not a constructor') ||\n                           error.message?.includes('better-sqlite3') ||\n                           error.message?.includes('could not run migrations');\n      const isNpx = process.env.npm_config_user_agent?.includes('npx') ||\n                    process.cwd().includes('_npx');\n\n      if (isSqliteError && isNpx) {\n        // NPX limitation - show helpful message but DON'T throw\n        // This allows the command to fall back to JSON mode\n        console.error('\\nâš ï¸  NPX LIMITATION DETECTED\\n');\n        console.error('ReasoningBank requires better-sqlite3, which is not available in npx temp directories.\\n');\n        console.error('ðŸ“š Solutions:\\n');\n        console.error('  1. LOCAL INSTALL (Recommended):');\n        console.error('     npm install && node_modules/.bin/claude-flow memory store \"key\" \"value\"\\n');\n        console.error('  2. USE MCP TOOLS instead:');\n        console.error('     mcp__claude-flow__memory_usage({ action: \"store\", key: \"test\", value: \"data\" })\\n');\n        console.error('  3. USE JSON FALLBACK (automatic):');\n        console.error('     Command will continue with JSON storage...\\n');\n        console.error('See: docs/MEMORY_COMMAND_FIX.md for details\\n');\n\n        // Return false to signal initialization failed but allow fallback\n        return false;\n      }\n\n      // Not npx or not SQLite error - log and throw\n      console.error('[ReasoningBank] Backend initialization failed:', error);\n      throw new Error(`Failed to initialize ReasoningBank: ${error.message}`);\n    }\n  })();\n\n  return initPromise;\n}\n\n/**\n * Initialize ReasoningBank database (Node.js version)\n * Returns true if initialized, false if failed (allows fallback)\n */\nexport async function initializeReasoningBank() {\n  // Initialize the Node.js backend\n  const result = await ensureInitialized();\n  return result;\n}\n\n/**\n * Store a memory in ReasoningBank (Node.js backend with SQLite)\n *\n * Maps claude-flow memory model to ReasoningBank pattern model:\n * - key -> title\n * - value -> content (searchable text)\n * - namespace -> domain\n * - confidence -> confidence score\n */\nexport async function storeMemory(key, value, options = {}) {\n  const initialized = await ensureInitialized();\n\n  // If initialization failed, throw with clear message\n  if (!initialized) {\n    throw new Error('ReasoningBank not available (better-sqlite3 missing). Use JSON mode instead.');\n  }\n\n  try {\n    const memoryId = options.id || uuidv4();\n\n    // Map our memory model to ReasoningBank pattern model\n    const memory = {\n      id: memoryId,\n      type: 'reasoning_memory',\n      pattern_data: {\n        title: key,\n        content: value,\n        domain: options.namespace || 'default',\n        agent: options.agent || 'memory-agent',\n        task_type: options.type || 'fact',\n        // Store original values for compatibility\n        original_key: key,\n        original_value: value,\n        namespace: options.namespace || 'default'\n      },\n      confidence: options.confidence || 0.8,\n      usage_count: 0\n    };\n\n    // Store memory using Node.js backend\n    ReasoningBank.db.upsertMemory(memory);\n\n    // Generate and store embedding for semantic search\n    try {\n      const embedding = await ReasoningBank.computeEmbedding(value);\n      ReasoningBank.db.upsertEmbedding({\n        id: memoryId,\n        model: 'text-embedding-3-small', // Default model\n        dims: embedding.length,\n        vector: embedding\n      });\n    } catch (embeddingError) {\n      console.warn('[ReasoningBank] Failed to generate embedding:', embeddingError.message);\n      // Continue without embedding - memory is still stored\n    }\n\n    // Invalidate query cache when new memory is added\n    queryCache.clear();\n\n    return memoryId;\n  } catch (error) {\n    console.error('[ReasoningBank] storeMemory failed:', error);\n    throw new Error(`Failed to store memory: ${error.message}`);\n  }\n}\n\n/**\n * Query memories from ReasoningBank (Node.js backend with semantic search)\n *\n * Uses retrieveMemories for semantic search via embeddings and MMR ranking\n * Fallback to database query if semantic search fails\n */\nexport async function queryMemories(searchQuery, options = {}) {\n  // Check cache first\n  const cached = getCachedQuery(searchQuery, options);\n  if (cached) {\n    return cached;\n  }\n\n  const initialized = await ensureInitialized();\n\n  // If initialization failed, return empty results\n  if (!initialized) {\n    return [];\n  }\n  const limit = options.limit || 10;\n  // Accept both 'namespace' and 'domain' for compatibility\n  const namespace = options.namespace || options.domain || 'default';\n\n  try {\n    // Try semantic search first using retrieveMemories\n    const results = await ReasoningBank.retrieveMemories(searchQuery, {\n      domain: namespace,\n      agent: options.agent || 'query-agent',\n      k: limit,\n      minConfidence: options.minConfidence || 0.3\n    });\n\n    // Map backend results to our memory format\n    // retrieveMemories returns: { id, title, content, description, score, components }\n    const memories = results.map(memory => ({\n      id: memory.id,\n      key: memory.title || 'unknown',\n      value: memory.content || memory.description || '',\n      namespace: namespace, // Use the namespace from our query\n      confidence: memory.components?.reliability || 0.8,\n      usage_count: memory.usage_count || 0,\n      created_at: memory.created_at || new Date().toISOString(),\n      score: memory.score || 0,\n      // Include original pattern for debugging\n      _pattern: memory\n    }));\n\n    // If no results, try direct database query as fallback\n    if (memories.length === 0) {\n      console.warn('[ReasoningBank] Semantic search returned 0 results, trying database fallback');\n      const fallbackResults = ReasoningBank.db.fetchMemoryCandidates({\n        domain: namespace,\n        minConfidence: options.minConfidence || 0.3\n      });\n\n      const fallbackMemories = fallbackResults.slice(0, limit).map(memory => ({\n        id: memory.id,\n        key: memory.pattern_data?.title || memory.pattern_data?.original_key || 'unknown',\n        value: memory.pattern_data?.content || memory.pattern_data?.original_value || '',\n        namespace: memory.pattern_data?.domain || memory.pattern_data?.namespace || 'default',\n        confidence: memory.confidence || 0.8,\n        usage_count: memory.usage_count || 0,\n        created_at: memory.created_at || new Date().toISOString()\n      }));\n\n      // Cache and return fallback results\n      setCachedQuery(searchQuery, options, fallbackMemories);\n      return fallbackMemories;\n    }\n\n    // Cache successful results\n    setCachedQuery(searchQuery, options, memories);\n    return memories;\n  } catch (error) {\n    console.warn('[ReasoningBank] Query failed, trying database fallback:', error.message);\n\n    try {\n      // Final fallback: direct database query\n      const fallbackResults = ReasoningBank.db.fetchMemoryCandidates({\n        domain: namespace,\n        minConfidence: options.minConfidence || 0.3\n      });\n\n      const fallbackMemories = fallbackResults.slice(0, limit).map(memory => ({\n        id: memory.id,\n        key: memory.pattern_data?.title || 'unknown',\n        value: memory.pattern_data?.content || '',\n        namespace: memory.pattern_data?.domain || 'default',\n        confidence: memory.confidence || 0.8,\n        usage_count: memory.usage_count || 0,\n        created_at: memory.created_at || new Date().toISOString()\n      }));\n\n      setCachedQuery(searchQuery, options, fallbackMemories);\n      return fallbackMemories;\n    } catch (fallbackError) {\n      console.error('[ReasoningBank] All query methods failed:', fallbackError);\n      return [];\n    }\n  }\n}\n\n/**\n * List all memories (using Node.js backend database query)\n */\nexport async function listMemories(options = {}) {\n  const initialized = await ensureInitialized();\n\n  // If initialization failed, return empty list\n  if (!initialized) {\n    return [];\n  }\n  const limit = options.limit || 10;\n  const namespace = options.namespace;\n\n  try {\n    let memories;\n\n    if (namespace && namespace !== 'default') {\n      // Filter by namespace/domain\n      const allMemories = ReasoningBank.db.getAllActiveMemories();\n      memories = allMemories\n        .filter(m => m.pattern_data?.domain === namespace)\n        .slice(0, limit);\n    } else {\n      // Get all active memories\n      memories = ReasoningBank.db.getAllActiveMemories().slice(0, limit);\n    }\n\n    return memories.map(memory => ({\n      id: memory.id,\n      key: memory.pattern_data?.title || memory.pattern_data?.original_key || 'unknown',\n      value: memory.pattern_data?.content || memory.pattern_data?.original_value || '',\n      namespace: memory.pattern_data?.domain || memory.pattern_data?.namespace || 'default',\n      confidence: memory.confidence || 0.8,\n      usage_count: memory.usage_count || 0,\n      created_at: memory.created_at || new Date().toISOString()\n    }));\n  } catch (error) {\n    console.error('[ReasoningBank] listMemories failed:', error);\n    return [];\n  }\n}\n\n/**\n * Get ReasoningBank statistics (Node.js backend)\n */\nexport async function getStatus() {\n  const initialized = await ensureInitialized();\n\n  // If initialization failed, return error status\n  if (!initialized) {\n    return {\n      total_memories: 0,\n      total_categories: 0,\n      storage_backend: 'Unavailable',\n      error: 'ReasoningBank initialization failed (better-sqlite3 not available)',\n      fallback_available: true\n    };\n  }\n\n  try {\n    const db = ReasoningBank.db.getDb();\n\n    // Count patterns\n    const patterns = db.prepare(\"SELECT COUNT(*) as count FROM patterns WHERE type = 'reasoning_memory'\").get();\n    const embeddings = db.prepare(\"SELECT COUNT(*) as count FROM pattern_embeddings\").get();\n    const trajectories = db.prepare(\"SELECT COUNT(*) as count FROM task_trajectories\").get();\n    const links = db.prepare(\"SELECT COUNT(*) as count FROM pattern_links\").get();\n\n    // Get average confidence\n    const avgConf = db.prepare(\"SELECT AVG(confidence) as avg FROM patterns WHERE type = 'reasoning_memory'\").get();\n\n    // Count unique domains\n    const domains = db.prepare(\"SELECT COUNT(DISTINCT json_extract(pattern_data, '$.domain')) as count FROM patterns WHERE type = 'reasoning_memory'\").get();\n\n    return {\n      total_memories: patterns.count || 0,\n      total_categories: domains.count || 0,\n      storage_backend: 'SQLite (Node.js)',\n      database_path: process.env.CLAUDE_FLOW_DB_PATH || '.swarm/memory.db',\n      performance: 'SQLite with persistent storage',\n      avg_confidence: avgConf.avg || 0.8,\n      total_embeddings: embeddings.count || 0,\n      total_trajectories: trajectories.count || 0,\n      total_links: links.count || 0\n    };\n  } catch (error) {\n    console.error('[ReasoningBank] getStatus failed:', error);\n    return {\n      total_memories: 0,\n      error: error.message\n    };\n  }\n}\n\n/**\n * Check which ReasoningBank tables are present (Node.js backend)\n */\nexport async function checkReasoningBankTables() {\n  try {\n    await ensureInitialized();\n    const db = ReasoningBank.db.getDb();\n\n    const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'pattern%'\").all();\n    const tableNames = tables.map(t => t.name);\n\n    const requiredTables = ['patterns', 'pattern_embeddings', 'pattern_links', 'task_trajectories'];\n    const missingTables = requiredTables.filter(t => !tableNames.includes(t));\n\n    return {\n      exists: true,\n      existingTables: tableNames,\n      missingTables: missingTables,\n      requiredTables: requiredTables,\n      backend: 'SQLite (Node.js)',\n      note: missingTables.length > 0 ? 'Some tables are missing - run migrations' : 'All tables present'\n    };\n  } catch (error) {\n    return {\n      exists: false,\n      existingTables: [],\n      missingTables: [],\n      requiredTables: [],\n      error: error.message\n    };\n  }\n}\n\n/**\n * Migrate existing database (Node.js backend - run migrations)\n */\nexport async function migrateReasoningBank() {\n  try {\n    await ReasoningBank.db.runMigrations();\n\n    return {\n      success: true,\n      message: 'Database migrations completed successfully',\n      migrated: true,\n      database_path: process.env.CLAUDE_FLOW_DB_PATH || '.swarm/memory.db'\n    };\n  } catch (error) {\n    return {\n      success: false,\n      message: `Migration failed: ${error.message}`,\n      error: error.message\n    };\n  }\n}\n\n/**\n * Get cached query results\n */\nfunction getCachedQuery(searchQuery, options) {\n  const cacheKey = JSON.stringify({ searchQuery, options });\n  const cached = queryCache.get(cacheKey);\n\n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n    return cached.results;\n  }\n\n  return null;\n}\n\n/**\n * Set cached query results (LRU eviction)\n */\nfunction setCachedQuery(searchQuery, options, results) {\n  const cacheKey = JSON.stringify({ searchQuery, options });\n\n  // LRU eviction\n  if (queryCache.size >= CACHE_SIZE) {\n    const firstKey = queryCache.keys().next().value;\n    queryCache.delete(firstKey);\n  }\n\n  queryCache.set(cacheKey, {\n    results,\n    timestamp: Date.now()\n  });\n}\n\n/**\n * Close database connection and cleanup resources\n * Should be called when done with ReasoningBank operations\n */\nexport function cleanup() {\n  try {\n    if (backendInitialized) {\n      // Clear embedding cache (prevents memory leaks)\n      ReasoningBank.clearEmbeddingCache();\n\n      // Close database connection\n      ReasoningBank.db.closeDb();\n      backendInitialized = false;\n      initPromise = null;\n      console.log('[ReasoningBank] Database connection closed');\n    }\n  } catch (error) {\n    console.error('[ReasoningBank] Cleanup failed:', error.message);\n  }\n}\n"],"names":["ReasoningBank","v4","uuidv4","backendInitialized","initPromise","queryCache","Map","CACHE_SIZE","CACHE_TTL","ensureInitialized","initialize","console","log","error","isSqliteError","message","includes","isNpx","process","env","npm_config_user_agent","cwd","Error","initializeReasoningBank","result","storeMemory","key","value","options","initialized","memoryId","id","memory","type","pattern_data","title","content","domain","namespace","agent","task_type","original_key","original_value","confidence","usage_count","db","upsertMemory","embedding","computeEmbedding","upsertEmbedding","model","dims","length","vector","embeddingError","warn","clear","queryMemories","searchQuery","cached","getCachedQuery","limit","results","retrieveMemories","k","minConfidence","memories","map","description","components","reliability","created_at","Date","toISOString","score","_pattern","fallbackResults","fetchMemoryCandidates","fallbackMemories","slice","setCachedQuery","fallbackError","listMemories","allMemories","getAllActiveMemories","filter","m","getStatus","total_memories","total_categories","storage_backend","fallback_available","getDb","patterns","prepare","get","embeddings","trajectories","links","avgConf","domains","count","database_path","CLAUDE_FLOW_DB_PATH","performance","avg_confidence","avg","total_embeddings","total_trajectories","total_links","checkReasoningBankTables","tables","all","tableNames","t","name","requiredTables","missingTables","exists","existingTables","backend","note","migrateReasoningBank","runMigrations","success","migrated","cacheKey","JSON","stringify","now","timestamp","size","firstKey","keys","next","delete","set","cleanup","clearEmbeddingCache","closeDb"],"mappings":"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"}